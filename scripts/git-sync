#!/usr/bin/env bash
#
# git-sync [--push]
# Sync your feature/* or bugfix/* with develop,
# or hotfix/* with main, using rebase with autostash.
# Optionally push/create remote branch after.
#
set -euo pipefail

error() { printf 'Error: %s\n' "$1" >&2; exit 1; }
usage() {
  cat <<EOF
Usage: $(basename "$0") [--push]
  --push    after syncing, push (and create) remote branch
EOF
  exit 1
}

get_branch_name() {
  git rev-parse --abbrev-ref HEAD 2>/dev/null \
    || error "⚠️  Not a git repo or cannot detect current branch."
}

detect_base() {
  [[ "${BRANCH%%/*}" == hotfix ]] && echo main || echo develop
}

validate_prefix() {
  [[ "${BRANCH}" =~ ^(feature|bugfix|hotfix)/.+$ ]] \
    || error "⚠️  Branch name must start with feature/, bugfix/ or hotfix/."
}

fetch_with_prune() {
  echo "→ [STEP 1/2] Fetch remote and prune"
  git fetch --prune origin
}

sync_rebase() {
  echo "→ [STEP 2/2] Rebase '${BRANCH}' onto 'origin/${BASE}' with auto-stash"
  if ! git rebase "origin/${BASE}" --autostash; then
    error "⚠️  Rebase failed. Resolve conflicts and run 'git rebase --continue' or 'git rebase --abort'."
  fi
}

push_remote() {
  echo "→ [Push mode] Checking remote branch 'origin/${BRANCH}'"
  local ORIGIN_OLD
  ORIGIN_OLD=$(git ls-remote origin "refs/heads/${BRANCH}" | awk '{print $1}') || ORIGIN_OLD=
  local LOCAL
  LOCAL=$(git rev-parse HEAD)

  if [[ -z "${ORIGIN_OLD}" ]]; then
    echo "↳ Remote does not exist → creating with push -u"
    git push -u origin "HEAD:${BRANCH}" \
      || error "⚠️  Failed to create remote branch."
    return
  fi

  if [[ "${LOCAL}" == "${ORIGIN_OLD}" ]]; then
    echo "↳ No new commits to push."
    return
  fi

  if git merge-base --is-ancestor "${ORIGIN_OLD}" "${LOCAL}"; then
    echo "↳ Remote is behind → pushing fast-forward"
    git push origin "${BRANCH}" || error "⚠️  Push failed."
    return
  fi

  read -rp "⚠️  Remote and local have diverged. Force-push your rebased branch to origin/${BRANCH}? [y/N] " ans
  if [[ "${ans}" =~ ^[Yy]$ ]]; then
    git push --force-with-lease origin "${BRANCH}" \
      || error "⚠️  Force-push failed."
  else
    error "⚠️  Push aborted; to synchronize manually run: git push --force-with-lease origin ${BRANCH}"
  fi
}

main() {
  export GIT_SSH_COMMAND="ssh -o ControlMaster=auto -o ControlPersist=45s -o ControlPath=/tmp/ssh_mux_%h_%p_%r"

  local do_push=false
  if [[ "${1-}" == "--push" ]]; then
    do_push=true
    shift
  fi

  BRANCH=$(get_branch_name)
  BASE=$(detect_base)
  echo "→ Starting sync for '${BRANCH}' against '${BASE}'"

  validate_prefix
  fetch_with_prune
  sync_rebase

  if $do_push; then
    push_remote
    echo "✔ Local branch '${BRANCH}' rebased onto '${BASE}' and pushed to 'origin/${BRANCH}'"
  else
    echo "✔ Local branch '${BRANCH}' rebased onto '${BASE}'"
  fi
}

main "$@"
